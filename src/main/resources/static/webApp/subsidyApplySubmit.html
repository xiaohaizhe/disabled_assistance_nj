<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="renderer" content="webkit">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
	<link rel="stylesheet" href="../../layui/css/layui.css" media="all">
	<link rel="stylesheet" href="../../css/init.css">
	<link rel="stylesheet" href="../../css/search_form.css">
	<style>
	</style>
</head>
<body>

<div class="search-box">
	<form class="layui-form">
		<div class="layui-form-item layui-tab-title">
			<div class="layui-inline" style="padding:0 10px;">
				补贴资金申请
			</div>
		</div>
	</form>
</div>

<form class="layui-form"  lay-filter="org-form"  action="">
	<div class="layui-form-item">
		<div class="layui-inline">
			<label class="layui-form-label">机构名称</label>
			<div class="layui-input-inline">
				<input type="text" name="name" placeholder="请输入机构名称" autocomplete="off" class="layui-input">
			</div>
		</div>
		<div class="layui-inline">
			<label class="layui-form-label">登记注册时间</label>
			<div class="layui-input-inline">
				<input type="text"  name="registrationCertificateNumber" class="layui-input" id="registDate"  placeholder="请选择时间">
			</div>
		</div>
	</div>

	<div class="layui-form-item">
		<label class="layui-form-label">地址</label>
		<div class="layui-input-inline">
			<select lay-filter="province_sele" id="province_sele" name="province">
				<option value="">省/自治区/直辖市</option>
			</select>
		</div>
		<div class="layui-input-inline">
			<select lay-filter="city_sele" id="city_sele" name="city">
			</select>
		</div>
		<div class="layui-input-inline">
			<select lay-filter="cdistinct_sele" id="cdistinct_sele" name="distinct">
				<option value="雨花台区">区/县</option>
			</select>
		</div>
		<div class="layui-input-inline">
			<select id="block_sele" name="block" lay-verify="required">
			</select>
		</div>

	</div>

	<div class="layui-form-item" style="padding-left:50px;">
		<div class="layui-input-inline">
			<textarea name="detailedAddress" placeholder="详细地址" class="layui-textarea"></textarea>
		</div>
	</div>

	<div class="layui-form-item">
		<div class="layui-inline">
			<label class="layui-form-label">负责人</label>
			<div class="layui-input-inline">
				<input type="text" name="personInCharge" autocomplete="off" class="layui-input">
			</div>
		</div>
		<div class="layui-inline">
			<label class="layui-form-label">联系电话</label>
			<div class="layui-input-inline">
				<input type="number" name="contactNumber" autocomplete="off" class="layui-input">
			</div>
		</div>
	</div>

	<div class="layui-form-item">
		<div class="layui-inline">
			<label class="layui-form-label">机构面积</label>
			<div class="layui-input-inline">
				<input type="text" name="area" autocomplete="off" class="layui-input">
			</div>
			<div class="layui-form-mid layui-word-aux">m²</div>
		</div>
		<div class="layui-inline">
			<label class="layui-form-label">床位数</label>
			<div class="layui-input-inline">
				<input type="number" name="bedNum" autocomplete="off" class="layui-input">
			</div>
		</div>
	</div>

	<div class="layui-form-item">
		<div class="layui-inline">
			<label class="layui-form-label">机构性质</label>
			<div class="layui-input-inline">
				<input type="text" name="nature" autocomplete="off" class="layui-input">
			</div>
		</div>
		<div class="layui-inline">
			<label class="layui-form-label">庇护性劳动项目</label>
			<div class="layui-input-inline">
				<input type="text" name="asylumLaborProjects" autocomplete="off" class="layui-input">
			</div>
		</div>
	</div>

	<div class="layui-form-item">
		<div class="layui-inline">
			<label class="layui-form-label">符合条件的日托人数</label>
			<div class="layui-input-inline">
				<input type="text" name="numOfEligibleDayNursery" required  lay-verify="required\number" autocomplete="off" class="layui-input">
			</div>
		</div>
		<div class="layui-inline">
			<label class="layui-form-label">符合条件的全托人数</label>
			<div class="layui-input-inline">
				<input type="text" name="numOfEligibleBoardingNursery" required  lay-verify="required\number" autocomplete="off" class="layui-input">
			</div>
		</div>
	</div>

	<div class="layui-form-item">
		<div class="layui-inline">
			<label class="layui-form-label">申请机构全托运营补贴资金总额</label>
			<div class="layui-input-inline">
				<input type="text" name="subsidyFundForBoardingNursery" placeholder="￥" required  lay-verify="required\number" autocomplete="off" class="layui-input">
			</div>
			<div class="layui-form-mid layui-word-aux">万元</div>
		</div>
		<div class="layui-inline">
			<label class="layui-form-label">申请机构日托运营补贴资金总额</label>
			<div class="layui-input-inline">
				<input type="text" name="subsidyFundForDayNursery" placeholder="￥" required  lay-verify="required\number" autocomplete="off" class="layui-input">
			</div>
			<div class="layui-form-mid layui-word-aux">万元</div>
		</div>
	</div>

	<div class="layui-form-item">
		<div class="layui-inline">
			<label class="layui-form-label">上年当地资金投入情况</label>
			<div class="layui-input-inline">
				<input type="text" placeholder="￥" name="localInvestmentOfLastYear" required  lay-verify="required\number" autocomplete="off" class="layui-input">
			</div>
			<div class="layui-form-mid layui-word-aux">万元</div>
		</div>
		<div class="layui-inline">
			<label class="layui-form-label">申请托养机构运营补贴资金总额合计</label>
			<div class="layui-input-inline">
				<input type="text" name="totalSubsidyFunds"  placeholder="￥" required  lay-verify="required\number" autocomplete="off" class="layui-input">
			</div>
			<div class="layui-form-mid layui-word-aux">万元</div>
		</div>
	</div>

	<div class="layui-form-item">
		<div class="layui-inline">
			<label class="layui-form-label">托养残疾人名单</label>
			<div class="layui-input-inline" style="width: 400px;">
				<button type="button" class="layui-btn" id="test1">
					<i class="layui-icon">&#xe67c;</i>上传EXCEL
				</button>
				<a href="/api/apply/export_excel" download="模板">下载模板</a>

				<input style="display: none;" id="tycjrmd" type="text" placeholder="请输入" autocomplete="off" class="layui-input">
			</div>
		</div>
		<div class="layui-inline">
			<label class="layui-form-label">低保或其他低收入证明</label>
			<div class="layui-input-inline">
				<button type="button" class="layui-btn" id="test2">
					<i class="layui-icon">&#xe67c;</i>选择图片
				</button>
				<input style="display: none;" id="dbhqtdsrzm" type="text" placeholder="请输入" autocomplete="off" class="layui-input">
			</div>
		</div>
	</div>



	<div class="layui-form-item">
		<div class="layui-input-block">
			<button class="layui-btn" lay-submit lay-filter="formDemo">提交</button>
			<button type="reset" class="layui-btn layui-btn-primary">重置</button>
		</div>
	</div>
</form>


<script src="../../js/jquery.min.js"></script>
<script src="../js/address.js"></script>
<script src="../../layui/layui.js"></script>
<!--<script src="../../js/heightClient.js"></script>-->


<script>
    var form = null;
    var IMGS = [];
    layui.use(['laydate','form','upload','layer'], function(){
        form = layui.form;
        var laydate = layui.laydate;
        var upload = layui.upload;
        var layer = layui.layer;
        var $ = layui.$;
        getAddress("cityList");
        getAddress("city","110000");
        getAddress("distinct","110101",form);
        form.render('select');
        form.on('select(province_sele)', function(data){
            getAddress("city",data.value);
            form.render('select');
        });
        form.on('select(city_sele)', function(data){
            getAddress("distinct",data.value);
            form.render('select');
        });
        form.on('select(cdistinct_sele)', function(data){
            getAddress("distinct",data.value,form);
        });
        $.ajax({
            type: "GET",
            url: "/api/org/getById",
            data: {id:2},
            success: function (data) {
                // console.log(data);
                form.render();
                form.val("org-form", data.data);
            }
        })

        //执行实例
        var uploadInst = upload.render({
            elem: '#test1' //绑定元素
            ,accept:"file"
            ,url: '/api/apply/import_excel' //上传接口
            ,data:{type:"nursingList"}
            ,done: function(res){
                if(res.data){
                    layer.msg('上传成功');
                    $("#tycjrmd").data("user",res.data).after(smail("../images/xls.png"))
                }
                //上传完毕回调
            }
            ,error: function(){
                //请求异常回调
            }
        });
        var uploadInst2 = upload.render({
            elem: '#test2' //绑定元素
            ,url: '/api/file/upload' //上传接口
            ,data:{type:"lowIncomeCertificate"}
            ,done: function(res){
                if(res.data){
                    layer.msg('上传成功');
                    $("#dbhqtdsrzm").val(res.data.fileUrl).after(smail(res.data.fileUrl));
                    IMGS.push(res.data.fileUrl)
                }
                //上传完毕回调
            }
            ,error: function(){
                //请求异常回调
            }
        });
        function smail(str){
            if(str){
                if(str.indexOf(".jpg") != -1 || str.indexOf(".png") != -1){
                    return '<img src="'+str+'" style="width: 60px;">'
                }else if(str.indexOf(".doc") != -1 || str.indexOf(".docx") != -1){
                    return '<img src="../images/word.png" style="width: 60px;">'
                }else if(str.indexOf(".xls") != -1 || str.indexOf(".xlsx") != -1){
                    return '<img src="../images/xls.png" style="width: 60px;">'
                }else {
                    return '<img src="'+str+'" style="width: 60px;">'
				}
			}else {
                return "";
			}

        }
        //执行一个laydate实例
        laydate.render({
            elem: '#registDate' //指定元素
        });
        //监听提交
        form.on('submit(formDemo)', function(data){
            var _data = data.field;
            delete _data['file'];
            _data.userList = $("#tycjrmd").data("user");
            _data.adminId = localStorage.getItem("userId");
            _data.organizationId = localStorage.getItem("jgid");
            _data.organizationName = _data.name;
            _data.registrationTime = _data.registrationCertificateNumber;
            _data.lowIncomeCertificate = IMGS.join(",");
            _data.province = provinceList[_data.province];
            _data.city = provinceList[_data.city];
            _data.distinct = provinceList[_data.distinct];
            _data.block = window["bloks"][_data.block];
            _data.address = _data.city+_data.distinct+_data.block;
            $.ajax({
                type: "POST",
                url: "/api/apply/saveAndFlush",
                data: JSON.stringify(_data),
                dataType:"json",
                contentType : 'application/json;charset=utf-8',
                processData: false,
                success: function (data) {
                    layer.alert(data.msg, {icon: 1});
                },
                error:function () {
                    layer.alert('提交失败', {icon: 2});
                }
            })
            return false;
        });
    });
    function getAddress(type,value,_form) {
        var html = [];
        var iszxs = false;
        var zxs = [];
        var ciitys = [];
        for(var key in provinceList){
            if(type == "cityList" && key.indexOf("0000") !== -1){
                html.push('<option value="'+key+'">'+provinceList[key]+'</option>');
            }else if(type == "city"
                && key.indexOf("0000") == -1
                && key.slice(0,3) == value.slice(0,3)
            ){
                if(key.slice(-2) == "00"){
                    iszxs = true;
                    ciitys.push(key);
                    html.push('<option value="'+key+'">'+provinceList[key]+'</option>');
                }else {
                    zxs.push('<option value="'+key+'">'+provinceList[key]+'</option>');
                }
            }else if(type == "distinct"
                && key.indexOf("0000") == -1
                && value.slice(-2) == "00"
                && key.slice(0,4) == value.slice(0,4)
            ){
                if(key.slice(-2) !== "00"){
                    ciitys.push(key);
                    html.push('<option value="'+key+'">'+provinceList[key]+'</option>');
                }
            }
        }
        if(html.length == 0 && zxs.length == 0){
            $.ajax({
                url: 'http://passer-by.com/data_location/town/' + value + '.json',
                dataType: 'json',
                success: function(town) {
                    window["bloks"] = town;
                    for(var key in town){
                        html.push('<option value="'+key+'">'+town[key]+'</option>');
                    }
                    $("#block_sele").html(html.join(""))
                    _form.render('select');
                }
            });
        }
        // return html.join("");
        if(!value){
            $("#province_sele").html(html.join(""))
        }else if(iszxs && type == "city"){
            $("#city_sele").html(html.join(""));
            getAddress("distinct",""+ciitys[0]);
        }else if(type == "city" ){
            $("#cdistinct_sele").html(zxs.join(""));
        }else if(type == "distinct" && html.length !== 0){
            $("#cdistinct_sele").html(html.join(""));
            getAddress("distinct",""+ciitys[0],form);
        }
    }
</script>
</body>
</html>